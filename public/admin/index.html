<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Private CMS</title>
  <script>window.CMS_MANUAL_INIT = true;</script>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:#f4f5f7;margin:0;padding:40px}
    #app{max-width:960px;margin:0 auto}
    .card{background:#1f2937;color:#e5e7eb;padding:16px 20px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,.08);display:inline-block}
  </style>
</head>
<body>
  <div id="app"><div class="card">PRIVATE CMS — Authenticated. Loading collections…</div></div>

  <script src="https://cdn.jsdelivr.net/npm/decap-cms@^3.0.11/dist/decap-cms.js"></script>
  <script>
  (async function(){
    try{
      const r = await fetch('/api/cms/config',{cache:'no-store',headers:{accept:'application/json'}});
      if(!r.ok){ const txt = await r.text(); document.getElementById('app').innerHTML = '<pre>'+txt+'</pre>'; return; }
      const cfg = await r.json();

      // Nuke any OAuth bits just in case
      if (cfg.backend) {
        if (cfg.backend.auth_type !== 'token') {
          cfg.backend.auth_type = 'token';
        }
        delete cfg.backend.base_url;
        delete cfg.backend.auth_endpoint;
      }
      // Prevent netlify identity fallback
      window.netlifyIdentity = undefined;

      window.CMS.init({ config: cfg });
    }catch(e){
      document.getElementById('app').innerHTML = '<pre>Admin boot error:\n'+(e?.message||e)+'</pre>';
    }
  })();
  </script>
</body>
</html>
